<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.web.bigdata.model.mapper.UserMapper">
	
	<!-- UserController -->

	<select id="getAllUser" resultType="UserDto">
		select email, nickname, role, profile_image, id_user
<!-- 		, count(distinct post.postNo) as postCnt, count(distinct commentNo) as commentCnt -->
<!--         from USER left join REVIEW using(EMAIL) -->
<!--         left join comment using(EMAIL) -->
<!--         group by EMAIL; -->
		from user
	</select>
	
	<select id="getRole" parameterType="string" resultType="string">
		select role
		from user
		where email = #{email}
	</select>

	<insert id="join" parameterType="UserDto">
		insert into user (email, password, nickname, born_year, gender)
		values (#{email}, #{password}, #{nickname}, #{born_year}, #{gender})
	</insert>

	<select id="emailCheck" parameterType="string" resultType="string">
		select email
		from user
		where email = #{email}
	</select>

	<select id="nameCheck" parameterType="string" resultType="string">
		select nickname
		from user
		where nickname = #{nickname}
	</select>

	<select id="findUserInfo" parameterType="string" resultType="UserDto">
		select id_user, email, nickname, born_year, gender, favorites, profile_image
		from user
		where email=#{email}
	</select>
	
	<update id="updateNickname" parameterType="UserDto">
		update user
		set	nickname = #{nickname}
		where email = #{email}
	</update>

	<update id="updatePwd" parameterType="UserDto">
		update user
		set password = #{password}
		where email=#{email}
	</update>

	<update id="delete" parameterType="string">
		update user
		set active = 0
		where email=#{email}
	</update>

	<update id="saveImg" parameterType="UserDto">
		update user
		set profile_image = #{profile_image}
		where email=#{email}
	</update>

	<update id="deleteImg" parameterType="string">
		update user
		set profile_image = null
		where email=#{email}
	</update>

	<!-- LoginController -->
	
	<select id="login" parameterType="UserDto" resultType="UserDto">
		select email, password, nickname, role
		from user
		where email=#{email}
	</select>

	<select id="findPwd" parameterType="string" resultType="string">
		select password
		from user
		where email=#{email}
	</select>
	
	<select id="getStoreName" parameterType="string" resultType="string">
		select store_name
		from store join review r
		using(id_store)
		where id_review = #{id_review} and r.active = 1
	</select>
	
	<select id="getReviewList" parameterType="string" resultType="ReviewDto">
		select id_review, content, score, likeCnt, id_store,
<!-- 				case when date_format(upload_date, '%Y%m%d') = date_format(now(), '%Y%m%d') -->
<!-- 				then date_format(upload_date, '%H:%i:%s') -->
<!-- 				else date_format(upload_date, '%y.%m.%d') -->
<!-- 				end -->
				 upload_date,
<!-- 				case when date_format(update_date, '%Y%m%d') = date_format(now(), '%Y%m%d') -->
<!-- 				then date_format(update_date, '%H:%i:%s') -->
<!-- 				else date_format(update_date, '%y.%m.%d') -->
<!-- 				end  -->
				update_date,
				(
					select store_name
					from store join review r2
					using(id_store)
					where r.id_review = r2.id_review and r.active = 1
				) as store_name						
		from review r join user
		using(id_user)
		where email = #{email} and r.active = 1
	</select>
	
	<select id="getBookmarkList" parameterType="string" resultType="BookmarkDto">
		select  id_store, id_bookmark,
			(
				select store_name
				from store join bookmark r
				using(id_store)
				where id_user = #{id_user} and r.active = 1
			) as store_name,
			(
				select avg(score)
				from review r2 join store s
				where s.id_store = r2.id_store and r2.active = 1
			) as score,
			(
				select address
				from store join bookmark r
				using(id_store)
				where id_user = #{id_user} and r.active = 1
			) as address							
		from bookmark b join user
		using(id_user)
		where id_user = #{id_user} and b.active = 1;
	</select>
	
</mapper>